name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Execute remote ssh commands using key
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # –¢–∞–π–º-–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –¥–æ–ª–≥–∞—è
          command_timeout: 30m
          script: |
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ü—É—Ç—å —Ç–µ–ø–µ—Ä—å –≤–µ–¥–µ—Ç –≤ –¥–æ–º–∞—à–Ω—é—é –ø–∞–ø–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deployer
            cd /home/deployer/k1-typing
            
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            echo "üì• Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main
            
            echo "üõë Stopping services..."
            docker-compose down
            
            # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω
            docker-compose rm -f
            
            echo "üöÄ Building and starting services..."
            # –ë–ª–∞–≥–æ–¥–∞—Ä—è –≥—Ä—É–ø–ø–µ docker (—à–∞–≥ 1.2), sudo –∑–¥–µ—Å—å –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
            docker-compose up -d --build
            
            echo "üßπ Cleaning up..."
            docker image prune -f