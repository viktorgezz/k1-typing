#!/bin/bash

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
PROJECT_KEY="k1typing"
SONAR_HOST="http://localhost:9000"
PROJECT_DIR="k1-typing-backend"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f ".env" ]; then
    echo "üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env —Ñ–∞–π–ª–∞..."
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env (–∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
    export $(grep -v '^#' .env | grep -v '^$' | xargs)
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω SonarQube –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ .env
if [ -z "$SONAR_TOKEN" ]; then
    echo "------------------------------------------------------------"
    echo "‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SONAR_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –æ–¥–Ω–∏–º –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:"
    echo "  1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:"
    echo "     SONAR_TOKEN='your-token-here'"
    echo "  2. –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
    echo "     export SONAR_TOKEN='your-token-here'"
    echo "------------------------------------------------------------"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "--- –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CI ---"

# --- [–ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ç–∫–∏ ---
if [ "$CURRENT_BRANCH" != "dev" ]; then
    echo "------------------------------------------------------------"
    echo "‚ùå –û–®–ò–ë–ö–ê: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¢–û–õ–¨–ö–û –¥–ª—è –≤–µ—Ç–∫–∏ 'dev'."
    echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ dev: git checkout dev"
    echo "------------------------------------------------------------"
    exit 1
fi

# --- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ---
if [ ! -f "pom.xml" ]; then
    if [ -d "$PROJECT_DIR" ]; then
        echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_DIR"
        cd "$PROJECT_DIR" || exit 1
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª pom.xml. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞."
        exit 1
    fi
fi

# --- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ç–µ—Å—Ç–æ–≤ ---
echo "[1/3] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞ SonarQube –Ω–∞ –≤–µ—Ç–∫–µ dev..."

./mvnw clean verify sonar:sonar \
  -Dsonar.projectKey="$PROJECT_KEY" \
  -Dsonar.host.url="$SONAR_HOST" \
  -Dsonar.token="$SONAR_TOKEN" \
  -Dsonar.qualitygate.wait=true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ Maven
if [ $? -ne 0 ]; then
    echo "------------------------------------------------------------"
    echo "‚ùå –û–®–ò–ë–ö–ê: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞ –∏–ª–∏ Quality Gate –Ω–µ –ø—Ä–æ–π–¥–µ–Ω."
    echo "–ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω–µ–Ω. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ –∏–ª–∏ —Ç–µ—Å—Ç–∞—Ö."
    echo ""
    echo "üìä –î–µ—Ç–∞–ª–∏ Quality Gate:"
    echo "   $SONAR_HOST/dashboard?id=$PROJECT_KEY"
    echo ""
    echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º —Ç–µ—Å—Ç–∞–º–∏"
    echo "   - –ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞"
    echo "   - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
    echo "   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥"
    echo "------------------------------------------------------------"
    exit 1
fi

echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

# –í–æ–∑–≤—Ä–∞—Ç –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ git
if [[ "$PWD" == *"$PROJECT_DIR" ]]; then
    cd ..
fi

# --- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç ---
echo "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞:"
read -r commit_message

if [ -z "$commit_message" ]; then
    commit_message="auto-commit: dev checks passed"
fi

git add .
git commit -m "$commit_message"

echo "------------------------------------------------------------"
echo "üöÄ –£–°–ü–ï–•: –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω –≤ –≤–µ—Ç–∫—É dev."